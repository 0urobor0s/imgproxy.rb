# imgproxy.rb

[![CircleCI branch](https://img.shields.io/circleci/project/github/imgproxy/imgproxy.rb/master.svg?style=for-the-badge)](https://circleci.com/gh/imgproxy/imgproxy.rb) [![Gem](https://img.shields.io/gem/v/imgproxy.svg?style=for-the-badge)](https://rubygems.org/gems/imgproxy) [![rubydoc.org](https://img.shields.io/badge/rubydoc-reference-blue.svg?style=for-the-badge)](https://www.rubydoc.info/gems/imgproxy/)

[imgproxy](https://github.com/DarthSim/imgproxy) is a fast and secure standalone server for resizing and converting remote images. The main principles of imgproxy are simplicity, speed, and security.

## Installation

```
gem install imgproxy
```

or add it to your `Gemfile`:

```ruby
gem "imgproxy"
```

## Configuration

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  # imgproxy endpoint
  config.endpoint = "http://imgproxy.example.com"
  # hex-encoded signature key
  config.hex_key = "your_key"
  # hex-encoded signature salt
  config.hex_salt = "your_salt"
  # signature size. Defaults to 32
  config.signature_size = 5
  # use short processing option names (`rs` for `resize`, `g` for `gravity`, etc).
  # Defaults to true
  config.use_short_options = false
end
```

## Usage

```ruby
Imgproxy.url_for(
  "http://images.example.com/images/image.jpg",
  width: 500,
  height: 400,
  resizing_type: :fill,
  sharpen: 0.5
)
# => http://imgproxy.example.com/2tjGMpWqjO/rs:fill:500:400/sh:0.5/plain/http://images.example.com/images/image.jpg
```

You can reuse processing options by using `Imgproxy::Builder`:

```ruby
builder = Imgproxy::Builder.new(
  width: 500,
  height: 400,
  resizing_type: :fill,
  sharpen: 0.5
)

builder.url_for("http://images.example.com/images/image1.jpg")
builder.url_for("http://images.example.com/images/image2.jpg")
```

Available options are:

* `resizing_type`
* `width`
* `height`
* `dpr`
* `enlarge`
* `extend`
* `gravity`
* `gravity_x`
* `gravity_y`
* `quality`
* `background`
* `blur`
* `sharpen`
* `watermark_opacity`
* `watermark_position`
* `watermark_x_offset`
* `watermark_y_offset`
* `watermark_scale`
* `preset`
* `cachebuster`
* `format`
* `use_short_options`

_See [imgproxy URL format guide](https://github.com/DarthSim/imgproxy/blob/master/docs/generating_the_url_advanced.md) for more info_

### Using with ActiveStorage

If you use [ActiveStorage](https://guides.rubyonrails.org/active_storage_overview.html), you can configure imgproxy gem to work with ActiveStorage attachments:

```ruby
Imgproxy.configure do |config|
  config.url_adapters.add Imgproxy::UrlAdapters::ActiveStorage.new
end

Imgproxy.url_for(user.avatar, width: 250, height: 250)
```

If you configured both your imgproxy server and ActiveStorage for working with Amazon S3, you may want to use short and beautiful `s3://...` source URLs instead of long ones generated by Rails. To do so, configure imgproxy gem to use `Imgproxy::UrlAdapters::ActiveStorageS3` adapter:

```ruby
Imgproxy.configure do |config|
  config.url_adapters.add Imgproxy::UrlAdapters::ActiveStorageS3.new
end
```

You can do the same for Google Cloud Storage with `Imgproxy::UrlAdapters::ActiveStorageGCS` adapter:

```ruby
Imgproxy.configure do |config|
  # ActiveStorage hides GCS config in private,
  # so we have to provide bucket name directly to adapter
  config.url_adapters.add Imgproxy::UrlAdapters::ActiveStorageGCS.new("my_bucket")
end
```

### Making your own URL adapter

URL adapter is a simple class that implements `applicable?` and `url` methods. See the example below:

```ruby
class MyItemAdapter
  def applicable?(item)
    item.is_a? MyItem
  end

  def url(item)
    item.image_url
  end
end

Imgproxy.configure do |config|
  config.url_adapters.add MyItemAdapter.new
end
```

## Contributing

Bug reports and pull requests are welcome on GitHub at https://github.com/imgproxy/imgproxy.rb.

## License
The gem is available as open source under the terms of the [MIT License](http://opensource.org/licenses/MIT).
