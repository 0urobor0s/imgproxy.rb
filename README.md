# imgproxy.rb

[![CircleCI branch](https://img.shields.io/circleci/project/github/imgproxy/imgproxy.rb/master.svg?style=for-the-badge)](https://circleci.com/gh/imgproxy/imgproxy.rb) [![Gem](https://img.shields.io/gem/v/imgproxy.svg?style=for-the-badge)](https://rubygems.org/gems/imgproxy) [![rubydoc.org](https://img.shields.io/badge/rubydoc-reference-blue.svg?style=for-the-badge)](https://www.rubydoc.info/github/imgproxy/imgproxy.rb/master)

Gem for [imgproxy](https://github.com/DarthSim/imgproxy) URLs generation with Active Storage and Shrine support.

[imgproxy](https://github.com/DarthSim/imgproxy) is a fast and secure standalone server for resizing and converting remote images. The main principles of imgproxy are simplicity, speed, and security.

## Installation

```
gem install imgproxy
```

or add it to your `Gemfile`:

```ruby
gem "imgproxy"
```

## Configuration

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  # imgproxy endpoint
  config.endpoint = "http://imgproxy.example.com"
  # hex-encoded signature key
  config.hex_key = "your_key"
  # hex-encoded signature salt
  config.hex_salt = "your_salt"
end
```

### Using truncated signature

By default, imgproxy server uses a full-length signature (32 bytes), but signature length can be set with `IMGPROXY_SIGNATURE_SIZE` environment variable. If you configured your imgproxy server to use truncated signatures, you need to configure the gem too:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  config.signature_size = 5
end
```

### Using full processing options names

By default imgproxy gem uses short processing options names (`rs` for `resize`, `g` for `gravity`, etc), but it can be configured to use full names:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  config.use_short_options = false
end
```

## Usage

### Using with Active Storage

imgproxy gem comes with built-in Active Storage support. It can be activated like this:

```ruby
# config/initializers/imgproxy.rb
Imgproxy.extend_active_storage
```

Now you can use `imgproxy_url` method of Active Storage attachments:

```ruby
user.avatar.imgproxy_url(width: 250, height: 250)
```

If you configured both your imgproxy server and Active Storage for working with Amazon S3, you may want to use short and beautiful `s3://...` source URLs instead of long ones generated by Rails:

```ruby
# config/initializers/imgproxy.rb
Imgproxy.extend_active_storage(use_s3: true)
```

You can do the same for Google Cloud Storage:

```ruby
# config/initializers/imgproxy.rb
Imgproxy.extend_active_storage(use_gcs: true, gcs_bucket: "my_bucket")
```

Note that you need to provide GCS bucket name because Active Storage hides GCS config in private.

### Using with Shrine

imgproxy gem comes with built-in Shrine support. It can be activated like this:

```ruby
# config/initializers/imgproxy.rb
Imgproxy.extend_shrine
```

Now you can use `imgproxy_url` method of `Shrine::UploadedFile`:

```ruby
user.avatar.imgproxy_url(width: 250, height: 250)
```

**Note:** If you use `Shrine::Storage::FileSystem` as storage, uploaded file URLs won't include host and imgproxy server won't have access to them. To fix this, initialize `Shrine::Storage::FileSystem` with `host` option:

```ruby
Shrine.storages = {
  store: Shrine::Storage::FileSystem.new("public", host: "http://your-host.test")
}
```

Or you can launch your imgproxy server with `IMGPROXY_BASE_URL` setting:

```
IMGPROXY_BASE_URL="http://your-host.test" imgproxy
```

If you configured both your imgproxy server and Shrine for working with Amazon S3, you may want to use short and beautiful `s3://...` source URLs:

```ruby
Imgproxy.extend_shrine(use_s3: true)
```

### Using the gem framework-agnostic way

If you don't use supported attachments gems or if you want to generate imgproxy URL for some random source URLs, you can use `Imgproxy.url_for` method:

```ruby
Imgproxy.url_for(
  "http://images.example.com/images/image.jpg",
  width: 500,
  height: 400,
  resizing_type: :fill,
  sharpen: 0.5
)
# => http://imgproxy.example.com/2tjGMpWqjO/rs:fill:500:400/sh:0.5/plain/http://images.example.com/images/image.jpg
```

You can reuse processing options by using `Imgproxy::Builder`:

```ruby
builder = Imgproxy::Builder.new(
  width: 500,
  height: 400,
  resizing_type: :fill,
  sharpen: 0.5
)

builder.url_for("http://images.example.com/images/image1.jpg")
builder.url_for("http://images.example.com/images/image2.jpg")
```

### Available options

* `resizing_type` - defines how imgproxy will resize the image. See [URL format guide](https://github.com/DarthSim/imgproxy/blob/master/docs/generating_the_url_advanced.md#resizing-type) for available values.
* `width` - defines the width of the resulting image.
* `height` - defines the height of the resulting image.
* `dpr` - when set, imgproxy will multiply the image dimensions according to this factor for HiDPI (Retina) devices.
* `enlarge` - when true, imgproxy will enlarge the image if it is smaller than the given size.
* `extend` - when true, imgproxy will extend the image if the resizing result is smaller than the given size.
* `gravity` - defines gravity that will be used when imgproxy needs to cut some parts of the image. See [URL format guide](https://github.com/DarthSim/imgproxy/blob/master/docs/generating_the_url_advanced.md#gravity) for available values.
* `gravity_x`, `gravity_y` - floating point numbers between 0 and 1 that define the coordinates of the center of the resulting image when `fp` gravity is used.
* `quality` - defines the quality of the resulting image, percentage.
* `background` - when set, imgproxy will fill the resulting image background with the specified color. Can be a hex-color string or an array of red, green and blue values (0-255).
* `blur` - when set, imgproxy will apply the gaussian blur filter to the resulting image. Value is the size of a mask imgproxy will use.
* `sharpen` - when set, imgproxy will apply the sharpen filter to the resulting image. Value is the size of a mask imgproxy will use.
* `watermark_opacity` - when set, imgproxy will put a watermark on the resulting image. See [watermars guide](https://github.com/DarthSim/imgproxy/blob/master/docs/watermark.md) for more info.
* `watermark_position`, `watermark_x_offset`, `watermark_y_offset`, `watermark_scale` - additional watermark options described in the [watermars guide](https://github.com/DarthSim/imgproxy/blob/master/docs/watermark.md).
* `preset` - array of names of presets that will be used by imgproxy. See [presets guide](https://github.com/DarthSim/imgproxy/blob/master/docs/presets.md) for more info.
* `cachebuster` - defines cache buster that doesn't affect image processing but it's changing allows to bypass CDN, proxy server and browser cache.
* `format` - specifies the resulting image format (`jpg`, `png`, `webp`, etc).
* `use_short_options` - per-call redefinition of `use_short_options` config.

_See [imgproxy URL format guide](https://github.com/DarthSim/imgproxy/blob/master/docs/generating_the_url_advanced.md) for more info_

### URL adapters

By default, `Imgproxy.url_for` accepts only `String` or `URI` as source URL, but you can extend this by using URL adapters. URL adapter is a simple class that implements `applicable?` and `url` methods. See the example below:

```ruby
class MyItemAdapter
  # `applicable?` checks if the adapter can extract source URL from the provided object
  def applicable?(item)
    item.is_a? MyItem
  end

  # `url` extracts source URL from the provided object
  def url(item)
    item.image_url
  end
end

Imgproxy.configure do |config|
  config.url_adapters.add MyItemAdapter.new
end
```

**Note:** `Imgproxy` will use the first applicable URL adapter. If you need to add your adapter to the beginning of the list, use the `prepend` method instead of `add`.

imgproxy gem provides adapters for Active Storage and Shrine that are automatically added by `Imgproxy.extend_active_storage` and `Imgproxy.extend_shrine`.

## Contributing

Bug reports and pull requests are welcome on GitHub at https://github.com/imgproxy/imgproxy.rb.

## License
The gem is available as open source under the terms of the [MIT License](http://opensource.org/licenses/MIT).
